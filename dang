import React, { Component } from 'react';
import './App.css';
import GraphGoog from './graphGoog.js';

Date.prototype.addDays = function(days){
  var dat = new Date(this.valueOf());
  dat.setDate(dat.getDate() + days);
  console.log(dat);
  return dat;
}

class App extends Component {

  constructor(props){
    super(props);
    var dateObj = new Date();
    var realDate = dateObj.toISOString().slice(0, 10);
    this.state = {
      daySequence: {
        dayOrder: [],
        dateOrder: []
      },
      dayToRender: '',
      currentDate: realDate,
      currTemp: '',
      dayMax: '',
    }
    this.renderForecast = this.renderForecast.bind(this);
  }

  componentDidMount(){
      console.log(2345);
      var url = 'http://api.openweathermap.org/data/2.5/forecast?id=4241704&APPID=';
      const APIKEY = '606932a10e94518fbb30ea03566eba3a';
      url += APIKEY;
      fetch(url)
        .then(res => res.json())
        .then(
          (result) => {
            var dateOrder = [];
            var dayOrder = [];
            var firstDate = result.list[0].dt_txt.slice(0, 11);
            dateOrder.push(firstDate);
            dayOrder.push(new Date(firstDate).getDay());
            var currDate = firstDate;
            result.list.forEach(
              function(obj){
                if(obj.dt_txt.slice(0, 11) != currDate){
                  console.log(1);
                  currDate = obj.dt_txt.slice(0, 11);
                  var date = new Date(currDate);
                  dayOrder.push(date.getDay());
                  dateOrder.push(currDate.slice(0, 11));
                }
              }
            )
            this.setState({
              currentDate: firstDate,
              weatherObj: result,
              daySequence: {
                dayOrder: dayOrder,
                dateOrder: dateOrder
              }
            });
          }
        )

      this.getCurrWeather();
  }

  displayForecast(index){
    this.setState({
      dayToRender: this.state.daySequence.dateOrder[index]
    });
  }

  renderForecast(){
    console.log(realDate);
    var dayToRender = this.state.dayToRender;
    var firstInstance = this.state.weatherObj.list.find(
      function(thirdHourlyTemp){
        return thirdHourlyTemp.dt_txt.slice(0, 11) === dayToRender;
      }
    );

    var currMax = firstInstance.main.temp;
    var dataArr = [];
    if(this.state.dayToRender === this.state.currentDate){
      var currentTime = dateObj.getHours() + ':';
      currentTime += (dateObj.getMinutes() / 10 < 1)? '0' + dateObj.getMinutes() : dateObj.getMinutes();
      dataArr.push(
        {
          temp: this.state.currTemp,
          time: currentTime
        });
    }
    this.state.weatherObj.list.forEach(
      function (obj){
        var date = obj.dt_txt.slice(0, 11);
        var thirdHourlyTemp = obj.main.temp;
        if(!date.localeCompare(dayToRender)){
          dataArr.push(
            {
              temp: ((thirdHourlyTemp - 273.15) * 9.0 / 5 + 32).toFixed(0),
              time: obj.dt_txt.slice(11)
            });
          if(thirdHourlyTemp > currMax){
              currMax = thirdHourlyTemp;
          }
        }
      }
    )
    var currMaxFahr = ((currMax - 273.15) * 9.0 / 5 + 32).toFixed(0);
    if(this.state.dayToRender === realDate){
      var genWeather = this.state.currWeatherObj.main;
      var weatherDetails = this.state.currWeatherObj.description;
      return (
        <div style = {{paddingLeft: '60px'}}>
          <p style = {{fontSize: '20px'}}>{this.state.currTemp}</p>
          <p>{genWeather}</p>
          <p>{weatherDetails}</p>
          <GraphGoog weatherData = {dataArr} />
        </div>
      );
    }
    else{
      var genWeather = firstInstance.weather[0].main;
      var weatherDetails = firstInstance.weather[0].description;
      return (
        <div style = {{paddingLeft: '60px'}}>
          <p style = {{fontSize: '20px'}}>{currMaxFahr}</p>
          <p>{genWeather}</p>
          <p>{weatherDetails}</p>
          <GraphGoog weatherData = {dataArr} />
        </div>
      );
    }
  }
  getCurrWeather(){
    var url = 'http://api.openweathermap.org/data/2.5/weather?id=4241704&APPID=';
    const APIKEY = '606932a10e94518fbb30ea03566eba3a';
    url += APIKEY;
    fetch(url)
      .then(res => res.json())
      .then(
        (result) => {
          var KelTemp = result.main.temp;
          var FahrTemp = ((KelTemp - 273.15) * 9 / 5 + 32).toFixed(0);
          this.setState({
            currTemp: FahrTemp,
            currWeatherObj: result.weather[0]
          });
        }
      )
      return null;
  }

  render() {
    return (
      <ul style = {{display: 'inline', paddingLeft: '60px'}}>
        {this.state.daySequence.dayOrder.map((i, index) => {
          return(
            <li key = {i} onClick = {() => this.displayForecast(index)} style = {{display: 'inline'}}>
              {this.state.weatherObj && this.state.currWeatherObj &&
                <DayCard day = {i} dateToRender = {this.state.daySequence.dateOrder[index]} currentDate = {this.state.currentDate} weatherObj = {this.state.weatherObj} currWeatherObj = {this.state.currWeatherObj}/>
              }
            </li>
          );
        })}
        {this.state.dayToRender && this.state.currWeatherObj && this.renderForecast()}
      </ul>
    );
  }
}

function DayCard(props){
  var firstInstance = props.weatherObj.list.find(
    function(thirdHourlyTemp){
      return thirdHourlyTemp.dt_txt.slice(0, 11) === props.dateToRender;
    }
  );
  var currMin = firstInstance.main.temp;
  var currMax = firstInstance.main.temp;
  props.weatherObj.list.forEach(
    function (obj){
      var date = obj.dt_txt.slice(0, 11);
      var thirdHourlyTemp = obj.main.temp;
      if(!date.localeCompare(props.dateToRender)){
        if(thirdHourlyTemp > currMax){
          currMax = thirdHourlyTemp;
        }
        else if(thirdHourlyTemp < currMin){
          currMin = thirdHourlyTemp;
        }
      }
    }
  )
  var currMinFahr = ((currMin - 273.15) * 9.0 / 5 + 32).toFixed(0);
  var currMaxFahr = ((currMax - 273.15) * 9.0 / 5 + 32).toFixed(0);
  var dayOfWeek = props.day;
  var dayOfWeekStr;
  switch(dayOfWeek){
    case 0: dayOfWeekStr = 'Sunday'; break;
    case 1: dayOfWeekStr = 'Monday'; break;
    case 2: dayOfWeekStr = 'Tuesday'; break;
    case 3: dayOfWeekStr = 'Wednesday'; break;
    case 4: dayOfWeekStr = 'Thursday'; break;
    case 5: dayOfWeekStr = 'Friday'; break;
    case 6: dayOfWeekStr = 'Saturday'; break;
  }
  var genWeather;
  var weatherDetails
  if(props.dateToRender === props.currentDate){
    genWeather = props.currWeatherObj.main;
    weatherDetails = props.currWeatherObj.description;
  }
  else{
    genWeather = firstInstance.weather[0].main;
    weatherDetails = firstInstance.weather[0].description;
  }
  var picSrc;
  switch(genWeather){
    case 'Rain': picSrc = 'sunnyRainy.jpg';
    break;
    case 'Clouds': picSrc = 'sunnyCloudy.jpg';
    break;
    case 'Clear': picSrc = 'sunny.jpg';
    break;
    case 'Thunderstorm': picSrc = 'thunderstorm.jpg';
  }

  return(
    <div style = {{display: 'inline-table', border: '1px solid lightgrey', padding: '10px', textAlign: 'center'}}>
      <p>{dayOfWeekStr}</p>
      <img style = {{width: '60px', height: '60px'}} src = {picSrc} alt = {genWeather}></img>
      <p style = {{fontSize: '18px'}}>{currMaxFahr}</p>
      <p style = {{fontSize: '15px', display: 'inline'}}>{currMaxFahr} &nbsp;</p>
      <p style = {{color: 'lightgrey', display: 'inline'}}>{currMinFahr}</p>
    </div>
  );
}

export default App;
